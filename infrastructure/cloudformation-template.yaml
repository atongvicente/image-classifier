AWSTemplateFormatVersion: '2010-09-09'
Description: 'AI Image Organizer - AWS Infrastructure (Free Tier Compatible)'

Parameters:
  InstanceType:
    Type: String
    Default: t3.micro
    AllowedValues:
      - t3.micro
      - t2.micro
    Description: EC2 instance type (t2.micro is free tier eligible)
  
  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: Name of an existing EC2 KeyPair to enable SSH access
  
  AllowedCidr:
    Type: String
    Default: 0.0.0.0/0
    Description: CIDR block allowed to access the application
  
  RepositoryUrl:
    Type: String
    Default: none
    Description: (Optional) Git repository URL to clone. Use 'none' to skip and upload manually.
  
  Branch:
    Type: String
    Default: main
    Description: Git branch to checkout (if using RepositoryUrl)

Resources:
  # VPC and Networking
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: AIImageOrganizer-VPC

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: AIImageOrganizer-IGW

  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC

  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: AIImageOrganizer-PublicSubnet

  RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: AIImageOrganizer-RouteTable

  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref RouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  SubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref RouteTable

  # Security Group
  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: AIImageOrganizer-SG
      GroupDescription: Security group for AI Image Organizer
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AllowedCidr
          Description: SSH access
        - IpProtocol: tcp
          FromPort: 8000
          ToPort: 8000
          CidrIp: !Ref AllowedCidr
          Description: FastAPI application
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP access
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS access
      Tags:
        - Key: Name
          Value: AIImageOrganizer-SG

  # IAM Role for EC2
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
      Tags:
        - Key: Name
          Value: AIImageOrganizer-EC2Role

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref EC2Role

  # EC2 Instance
  EC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: ami-0c55b159cbfafe1f0  # Amazon Linux 2023 (update for your region)
      InstanceType: !Ref InstanceType
      KeyName: !Ref KeyPairName
      IamInstanceProfile: !Ref EC2InstanceProfile
      SecurityGroupIds:
        - !Ref SecurityGroup
      SubnetId: !Ref PublicSubnet
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -e
          
          # Update system and install dependencies
          yum update -y
          yum install -y python3.11 python3.11-pip git unzip
          
          # Install application
          cd /home/ec2-user
          
          # Method 1: Clone from Git (if RepositoryUrl parameter is provided)
          if [ -n "${RepositoryUrl}" ] && [ "${RepositoryUrl}" != "none" ]; then
            echo "Cloning from Git repository: ${RepositoryUrl}"
            git clone ${RepositoryUrl} image-organizer || true
            cd image-organizer
            if [ -n "${Branch}" ] && [ "${Branch}" != "main" ]; then
              git checkout ${Branch}
            fi
          else
            # Method 2: Create directory structure (manual upload required)
            echo "Creating directory structure. You'll need to upload code manually."
            mkdir -p image-organizer
            cd image-organizer
          fi
          
          # Create virtual environment
          python3.11 -m venv venv
          source venv/bin/activate
          
          # Install Python dependencies (if requirements.txt exists)
          if [ -f requirements.txt ]; then
            pip install --upgrade pip
            pip install -r requirements.txt
          else
            echo "Warning: requirements.txt not found. Installing basic dependencies..."
            pip install --upgrade pip
            pip install fastapi uvicorn sqlmodel aiosqlite pydantic-settings python-multipart
            pip install Pillow torch transformers scikit-learn numpy greenlet
            pip install hdbscan albumentations opencv-python-headless cloudinary
          fi
          
          # Create .env file template
          cat > .env << 'ENVEOF'
          # Cloudinary Configuration (REQUIRED - update with your credentials)
          USE_CLOUDINARY=false
          CLOUDINARY_CLOUD_NAME=your_cloud_name
          CLOUDINARY_API_KEY=your_api_key
          CLOUDINARY_API_SECRET=your_api_secret
          
          # Database
          DATABASE_URL=sqlite+aiosqlite:///./image_organizer.db
          
          # CLIP Settings
          CLIP_MODEL_NAME=openai/clip-vit-base-patch32
          CLIP_DEVICE=cpu
          CLIP_USE_AUGMENTATION=true
          CLIP_NUM_AUGMENTATIONS=3
          
          # Clustering
          CLUSTERING_METHOD=hdbscan
          HDBSCAN_MIN_CLUSTER_SIZE=2
          
          # Application
          APP_NAME=AI Image Organizer
          ENVEOF
          
          # Create storage directory
          mkdir -p storage
          chmod 755 storage
          
          # Create systemd service
          cat > /etc/systemd/system/image-organizer.service << 'EOF'
          [Unit]
          Description=AI Image Organizer FastAPI
          After=network.target
          
          [Service]
          Type=simple
          User=ec2-user
          WorkingDirectory=/home/ec2-user/image-organizer
          Environment="PATH=/home/ec2-user/image-organizer/venv/bin"
          EnvironmentFile=/home/ec2-user/image-organizer/.env
          ExecStart=/home/ec2-user/image-organizer/venv/bin/uvicorn backend.app.main:app --host 0.0.0.0 --port 8000
          Restart=always
          RestartSec=10
          
          [Install]
          WantedBy=multi-user.target
          EOF
          
          systemctl daemon-reload
          systemctl enable image-organizer
          
          # Note: Service will start after code is uploaded
          echo "Setup complete. Upload your code to /home/ec2-user/image-organizer and run: sudo systemctl start image-organizer"
      Tags:
        - Key: Name
          Value: AIImageOrganizer-Instance

  # Elastic IP (optional, for static IP)
  ElasticIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      InstanceId: !Ref EC2Instance

Outputs:
  InstanceId:
    Description: Instance ID of the EC2 instance
    Value: !Ref EC2Instance
  
  PublicIP:
    Description: Public IP address of the instance
    Value: !Ref ElasticIP
  
  ApplicationURL:
    Description: URL to access the application
    Value: !Sub 'http://${ElasticIP}:8000'
  
  SSHCommand:
    Description: Command to SSH into the instance
    Value: !Sub 'ssh -i <your-key.pem> ec2-user@${ElasticIP}'

